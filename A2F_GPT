from openai import AzureOpenAI
from csv import writer
from TTS_elevenlabs import get_speech
import os, faiss, pickle, time
import streamlit as st
import numpy as np
import pandas as pd
from STT import convert_speech_text
from pythonosc import udp_client
from audio2face_streaming_utils import main

# Creates a ChatGPT client based on the key, endpoint and version details given below
client = AzureOpenAI(
    api_key=os.getenv('AZURE_OPENAI_KEY'),
    azure_endpoint=os.getenv('AZURE_OPENAI_ENDPOINT'),
    api_version="2023-12-01-preview",
)


###################################
# STEP 1: Load Index and Knowledge Base
###################################

def load_index(pickle_path, faiss_index_path): 
    # Pickle is a Python library used for serializing and deserializing Python objects.
    # Serialization: Converting a Python object (like a list, dictionary, DataFrame, etc.) into a byte stream.
    # Deserialization: Converting the byte stream back into the original Python object.
    with open(pickle_path, "rb") as f:
        context = pickle.load(f)
    index = faiss.read_index(faiss_index_path)
    return index, context



###################################
# STEP 2: Get Similarity Between Prompt and Knowledge Base
###################################

def get_similarity(index, knowledge, prompt, k):
    response = client.embeddings.create(model="text-embedding-ada-002", input=[prompt])
    embedding = response.data[0].embedding

    embedding_array = np.array(embedding).astype("float32")
    embedding_array = embedding_array.reshape(-1, embedding_array.shape[0])

    D, I = index.search(embedding_array, k=k)
    indices = I[0]

    selected = ""
    for i in indices:
        selected += "\n" + knowledge.iloc[i]

    return selected
